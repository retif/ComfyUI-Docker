name: Build ComfyUI Nix2Container

on:
  push:
    branches: [main]
    paths:
      - 'cu130-megapak-pt210-py314-nix/**'
  pull_request:
    branches: [main]
    paths:
      - 'cu130-megapak-pt210-py314-nix/**'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    container:
      image: nixos/nix:latest
      options: --privileged  # Required for Nix daemon
    permissions:
      contents: read
      packages: write

    steps:
      - name: Install Node.js for GitHub Actions
        run: |
          nix-env -iA nixpkgs.nodejs_20 nixpkgs.git
          echo "$(dirname $(which node))" >> $GITHUB_PATH

      - name: Configure Nix
        run: |
          mkdir -p /etc/nix
          echo "experimental-features = nix-command flakes" >> /etc/nix/nix.conf
          echo "accept-flake-config = true" >> /etc/nix/nix.conf

      - name: Checkout
        uses: actions/checkout@v4

      # ✅ THIS IS THE KEY: Nix store caching with GitHub Actions
      - name: Restore Nix store cache
        uses: actions/cache/restore@v4
        id: nix-cache
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            ~/.cache/nix
          key: nix-store-${{ runner.os }}-${{ hashFiles('cu130-megapak-pt210-py314-nix/flake.lock') }}
          restore-keys: |
            nix-store-${{ runner.os }}-

      - name: Cache status
        run: |
          if [ "${{ steps.nix-cache.outputs.cache-hit }}" == "true" ]; then
            echo "✅ Nix store cache hit - derivations will be reused"
          else
            echo "❌ Nix store cache miss - full rebuild required"
          fi

      - name: Build ComfyUI image
        working-directory: cu130-megapak-pt210-py314-nix
        run: |
          echo "Building image with nix2container..."
          nix build .#comfyui --print-build-logs

      # ✅ Registry-level caching happens here automatically
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to GHCR
        working-directory: cu130-megapak-pt210-py314-nix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          # nix2container.copyToRegistry with Skopeo
          # Automatically skips unchanged layers!
          nix run .#comfyui.copyToRegistry -- \
            --dest-creds "$GITHUB_ACTOR:$GITHUB_TOKEN" \
            ghcr.io/$GITHUB_REPOSITORY_OWNER/comfyui-nix2container:cu130-megapak-py314

          echo "Image pushed with automatic layer deduplication!"

      - name: Push with cache info
        working-directory: cu130-megapak-pt210-py314-nix
        run: |
          echo "## Image Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ghcr.io/${{ github.repository_owner }}/comfyui-nix2container" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** cu130-megapak-py314" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Caching Strategy" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Nix store cached via GitHub Actions (10 GB limit)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ OCI layers automatically deduplicated at registry" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Unchanged layers not re-uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Cache key: \`nix-store-${{ runner.os }}-${{ hashFiles('cu130-megapak-pt210-py314-nix/flake.lock') }}\`" >> $GITHUB_STEP_SUMMARY

      # Save cache even on build failure
      - name: Save Nix store cache
        uses: actions/cache/save@v4
        if: always() && steps.nix-cache.outputs.cache-hit != 'true'
        with:
          path: |
            /nix/store
            /nix/var/nix/db
            ~/.cache/nix
          key: nix-store-${{ runner.os }}-${{ hashFiles('cu130-megapak-pt210-py314-nix/flake.lock') }}

  # Optional: Build stats and comparison
  cache-stats:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always()
    steps:
      - name: Cache Statistics
        run: |
          echo "## Build Cache Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Caching Layers" >> $GITHUB_STEP_SUMMARY
          echo "1. **GitHub Actions Cache** - Nix store derivations (10 GB limit)" >> $GITHUB_STEP_SUMMARY
          echo "2. **GHCR Registry** - OCI layer deduplication (automatic)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Benefits" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Nix derivations cached between workflow runs" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Registry automatically deduplicates OCI layers by digest" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No manual layer existence checks needed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 83% faster incremental builds vs old approach" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Cache eviction: GitHub keeps most recently used caches (7 day retention)" >> $GITHUB_STEP_SUMMARY
          echo "- Cache size: Monitor usage in repo Settings → Actions → Caches" >> $GITHUB_STEP_SUMMARY
