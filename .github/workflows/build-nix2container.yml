name: Build ComfyUI Nix2Container

on:
  push:
    branches: [main]
    paths:
      - 'cu130-megapak-pt210-py314-nix/**'
  pull_request:
    branches: [main]
    paths:
      - 'cu130-megapak-pt210-py314-nix/**'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-slim  # Lighter runner, uses containers instead of VMs
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ✅ Free up disk space before build (recommended by cache-nix-action)
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false  # Keep swap for large builds

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true
            keep-outputs = true
            keep-derivations = true

      # ✅ Use cache-nix-action for better Nix caching
      - name: Restore and cache Nix store
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('cu130-megapak-pt210-py314-nix/flake.lock') }}
          restore-prefixes-first-match: nix-${{ runner.os }}-
          gc-max-store-size-linux: 8000000000  # 8GB - clean up old paths before saving
          purge: true
          purge-prefixes: nix-${{ runner.os }}-
          purge-last-accessed: 604800  # 7 days

      - name: Build ComfyUI image
        working-directory: cu130-megapak-pt210-py314-nix
        run: |
          echo "Building image with nix2container..."
          nix build .#comfyui --print-build-logs

      # ✅ Registry-level caching happens here automatically
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push to GHCR
        working-directory: cu130-megapak-pt210-py314-nix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          # nix2container.copyToRegistry with Skopeo
          # Automatically skips unchanged layers!
          nix run .#comfyui.copyToRegistry -- \
            --dest-creds "$GITHUB_ACTOR:$GITHUB_TOKEN" \
            ghcr.io/$GITHUB_REPOSITORY_OWNER/comfyui-nix2container:cu130-megapak-py314

          echo "Image pushed with automatic layer deduplication!"

      - name: Push with cache info
        working-directory: cu130-megapak-pt210-py314-nix
        run: |
          echo "## Image Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ghcr.io/${{ github.repository_owner }}/comfyui-nix2container" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** cu130-megapak-py314" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Caching Strategy" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Nix store cached via GitHub Actions (10 GB limit)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ OCI layers automatically deduplicated at registry" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Unchanged layers not re-uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Cache key: \`nix-${{ runner.os }}-${{ hashFiles('cu130-megapak-pt210-py314-nix/flake.lock') }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Automatic garbage collection (max 8GB store)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Cache purge: 7 days" >> $GITHUB_STEP_SUMMARY

  # Optional: Build stats and comparison
  cache-stats:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: always()
    steps:
      - name: Cache Statistics
        run: |
          echo "## Build Cache Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Caching Strategy (cache-nix-action)" >> $GITHUB_STEP_SUMMARY
          echo "1. **Nix Store Cache** - cache-nix-action with GC (8GB limit)" >> $GITHUB_STEP_SUMMARY
          echo "2. **GHCR Registry** - OCI layer deduplication (automatic)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Benefits" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Automatic garbage collection before cache save" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Old cache purging (7 day retention)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Registry automatically deduplicates OCI layers by digest" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Optimized for large Nix builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "- GC keeps store under 8GB before saving" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor: repo Settings → Actions → Caches" >> $GITHUB_STEP_SUMMARY
